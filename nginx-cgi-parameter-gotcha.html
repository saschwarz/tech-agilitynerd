<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <title>tech.agilitynerd</title>
    <meta name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Steve Schwarz">      <!-- <link href="https://tech.agilitynerd.com/TechAgilityNerd" type="application/atom+xml" rel="alternate" title="tech.agilitynerd Atom Feed" /> -->
    <link href="https://feeds.feedburner.com/TechAgilityNerd" type="application/atom+xml" rel="alternate" title="tech.agilitynerd Atom Feed" />       <!-- Le styles -->
    <link href="https://tech.agilitynerd.com/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }

        .sidebar-nav {
            padding: 9px 0;
        }

        @media (max-width: 767px) {
            .sidebar {
                margin-top: 2em;
                border-top: 1px solid #e3e3e3;
                padding-top: 1em;
            }
            .sidebar .search {
                margin-bottom: 0;
            }
        }
    </style>
    <link href="https://tech.agilitynerd.com/theme/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="https://tech.agilitynerd.com/theme/local.css" rel="stylesheet">
    <link href="https://tech.agilitynerd.com/theme/pygments.css" rel="stylesheet"> <script>var _gaq=[['_setAccount','UA-1127677-3'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))</script>
 <script type="text/javascript">
  var disqus_shortname = "techagilitynerd"; // required: replace example with your forum shortname
  var disqus_developer = 1;

  var disqus_identifier = "nginx-cgi-parameter-gotcha.html";
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();

  (function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>
</head>

<body>
    <!--[if lt IE 7]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->
  <div class="navbar navbar-inverse navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container-fluid">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
      </a>
      <a class="brand" href="https://tech.agilitynerd.com/index.html">tech.agilitynerd</a>
      <div class="nav-collapse collapse">
	<ul class="nav">
	  <li class="active"><a href="https://tech.agilitynerd.com/category/devops.html">devops</a></li>
	  <li ><a href="https://tech.agilitynerd.com/category/javascript.html">javascript</a></li>
	  <li ><a href="https://tech.agilitynerd.com/category/misc.html">misc</a></li>
	  <li ><a href="https://tech.agilitynerd.com/category/programming.html">programming</a></li>
	  <li ><a href="https://tech.agilitynerd.com/category/python.html">python</a></li>
	  <li ><a href="https://tech.agilitynerd.com/category/webdev.html">webdev</a></li>
	</ul>
	<p class="navbar-text pull-right">
	  <a class="navbar-link" href="https://tech.agilitynerd.com/archives.html">[archives]</a>
	  <a class="navbar-link" href="https://tech.agilitynerd.com/tags.html">[tags]</a>
	</p>
      </div><!--/.nav-collapse -->
    </div>
  </div>
</div>
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span1">&nbsp;</div>
            <div class="span10">
                <div class="row-fluid">
                    <div class="span9">
 <div class='article'>
  <div class="page-header"><h1>NGINX CGI Parameter Gotcha</h1></div>
  <div class="well small"><a class="more" href="https://tech.agilitynerd.com/nginx-cgi-parameter-gotcha.html">On 31 Jul 2016 at 1202</a>
by <a class="url fn" href="https://tech.agilitynerd.com/author/steve-schwarz.html">Steve Schwarz</a> in <a href="https://tech.agilitynerd.com/category/devops.html">devops</a>
 | <a href="https://tech.agilitynerd.com/nginx-cgi-parameter-gotcha.html#disqus_thread">Comments</a></div>
  <div><p>When I first started the <a class="reference external" href="http://agilitynerd.com">agilitynerd</a>  blog in 2004 I had my <a class="reference external" href="http://blosxom.sourceforge.net/">Blosxom</a> blogging CGI script running via <a class="reference external" href="http://httpd.apache.org/">Apache</a>. Later on I moved all my sites to <a class="reference external" href="https://nginx.org/en/">nginx</a> or took advantage of nginx's caching features to have it act as a proxy in front of Apache. I finally decided to remove Apache entirely and that meant solving running CGI scripts using nginx.</p>
<p>After some googling I found FastCGI and <a class="reference external" href="https://www.nginx.com/resources/wiki/start/topics/examples/fcgiwrap/">fcgiwrap</a></p>
<p>I'm on Ubuntu so installation was as easy as:</p>
<pre class="literal-block">
sudo apt-get install fcgiwrap
</pre>
<p>That setup the init script that starts the fcgi daemon. To run the cgi script(s) nginx has to be configured to parse apart the incoming URL, execute the appropriate script and pass along any arguments needed by the CGI script. Sounds easy.</p>
<p>I only want to support running a single CGI script: <tt class="docutils literal">index.cgi</tt> and pass along the path after the root of URL as the argument to the script. Most examples are more generic and parse out any cgi script and any arguments.</p>
<p>The key built-in to nginx to do the splitting is <tt class="docutils literal">fastcgi_split_path_info</tt> which takes a regex with two captured groups to parse out the script name and the arguments. These are stored in the <tt class="docutils literal">$fastcgi_script_name</tt> and the <tt class="docutils literal">$fastcgi_path_info</tt> variables respectively. This <a class="reference external" href="https://www.digitalocean.com/community/tutorials/understanding-and-implementing-fastcgi-proxying-in-nginx">Digital Ocean article</a> discusses FastCGI and has an excellent discussion of the variables available and also used by <tt class="docutils literal">fcgiwrap</tt>.</p>
<p>So I created this configuration file that matches <tt class="docutils literal"><span class="pre">http://agilitynerd.com/blog/foo.html</span></tt> and invokes <tt class="docutils literal"><span class="pre">/home/agilitynerd/cgi-bin/index.cgi</span> foo.html</tt>:</p>
<pre class="literal-block">
location /blog/ {
    root /home/agilitynerd/cgi-bin/;

    fastcgi_split_path_info ^(/blog)(.*)$;
    include /etc/nginx/fastcgi_params;
    fastcgi_param DOCUMENT_ROOT /home/agilitynerd/cgi-bin/;
    fastcgi_param SCRIPT_NAME index.cgi$fastcgi_path_info;

    # Fastcgi socket
    fastcgi_pass  unix:/var/run/fcgiwrap.socket;
}
</pre>
<p>You'll notice: <tt class="docutils literal">include /etc/nginx/fastcgi_params</tt> is used to get default values for the <tt class="docutils literal">fastcgi_param</tt> variables.</p>
<p>And it didn't work. I kept getting errors:</p>
<pre class="literal-block">
Cannot get script name, are DOCUMENT_ROOT and SCRIPT_NAME (or SCRIPT_FILENAME) set and is the script executable?&quot;
</pre>
<p>Clearly I'm setting <tt class="docutils literal">DOCUMENT_ROOT</tt> and <tt class="docutils literal">SCRIPT_NAME</tt>. After almost a day of googling and testing (during which I found this helpful article on <a class="reference external" href="https://blog.martinfjordvald.com/2013/06/debugging-nginx-errors/">nginx debugging</a>) I temporarily commented out <tt class="docutils literal">fastcgi_pass</tt>, and returned the variables.</p>
<p>I found that they were being set as I expected... Strange!</p>
<p>Then I came across this <a class="reference external" href="https://www.digitalocean.com/community/tutorials/understanding-and-implementing-fastcgi-proxying-in-nginx">Digital Ocean article</a> where they have a critical discussion on overriding variables in which they state:</p>
<blockquote>
This inconsistency and unpredictability means that you cannot and should not rely on the backend to correctly interpret your intentions when setting the same parameter more than one time. The only safe solution is to only declare each parameter once. This also means that there is no such thing as safely overriding a default value with the fastcgi_param directive.</blockquote>
<p>So in my case I commented out <tt class="docutils literal">DOCUMENT_ROOT</tt> and <tt class="docutils literal">SCRIPT_FILENAME</tt> in the <tt class="docutils literal">/etc/nginx/fastcgi_params</tt> file, reloaded nginx, and voila! Everything worked. Hope this helps you if you run in to the same problem.</p>
</div>
  <div>
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</div>	
                    </div>
                    <!--/span-->

                    <div class="span3 sidebar">
 <script>
  (function() {
    var cx = '001042720131993941673:szhtogqckem';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<div class="search">
    <gcse:search></gcse:search>
</div>
 <hr>
<div class="author">
<h4>About</h4>
<div class="author-about">
  <p class="about">I'm Steve Schwarz a Chicago software developer and dog agility enthusiast.
 <a href="/pages/about.html">more</a></p>
</div>
</div>
<div class="well sidebar-nav">
  <ul class="nav nav-list">
    <li class="nav-header">Blogroll</li>
    <li><a href="https://agilitycoursemaster.com">agilitycoursemaster.com</a></li>
    <li><a href="https://agilitynerd.com/blog/">agilitynerd.com</a></li>
    <li><a href="https://agilitycourses.com/">agilitycourses.com</a></li>
    <li><a href="https://googility.com/">googility.com</a></li>
  </ul>
  <ul class="nav nav-list social">
    <li class="nav-header">Elsewhere</li>
    <li><a href="https://www.linkedin.com/profile/view?id=10135443">Linked in</a></li>
    <li><a href="https://github.com/saschwarz">GitHub</a></li>
    <li><a href="https://twitter.com/steveaschwarz">Twitter</a></li>
  </ul>
</div><!--/.well -->
                    </div>
                    <!--/span-->

                </div>
            </div>
        </div>
        <!--/row-->

        <hr>

        <footer>
            <p>Powered by <a href="http://blog.getpelican.com/">Pelican</a></p>
            <p>&copy; Steve Schwarz 2019</p>
        </footer>

    </div>
    <!--/.fluid-container-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>
        window.jQuery || document.write('<script src="https://tech.agilitynerd.com/theme/js/jquery-1.7.2.min.js"><\/script>')
    </script>
    <script src="https://tech.agilitynerd.com/theme/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://tech.agilitynerd.com/theme/js/modernizr-2.5.3-respond-1.1.0.min.js"></script>

</body>

</html>