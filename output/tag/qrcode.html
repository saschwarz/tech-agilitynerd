<!DOCTYPE html>
<html lang="en">
<head>
        <title>tech.agilitynerd.com - qrcode</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../theme/css/main.css" type="text/css" />
                <link href="http://tech.agilitynerd.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="tech.agilitynerd.com Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie.css"/>
                <script src="../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">tech.agilitynerd.com </a></h1>
                <nav><ul>
                                                                                                    <li ><a href="../category/about.html">about</a></li>
                                    <li ><a href="../category/devops.html">devops</a></li>
                                    <li ><a href="../category/misc.html">misc</a></li>
                                    <li ><a href="../category/programming.html">programming</a></li>
                                    <li ><a href="../category/python.html">python</a></li>
                                    <li ><a href="../category/webdev.html">webdev</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
                
            

                            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../obtain-short-urls-and-their-qr-codes-for-djan.html">Obtain Short URLs and QR-Codes for Django Apps</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2010-10-22T04:00:00">
                Fri 22 October 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/steve-schwarz.html">Steve Schwarz</a>
        </address>
        <p>In <a href="../category/webdev.html">webdev</a>. </p>
<p>tags: <a href="../tag/django.html">django</a><a href="../tag/googl.html">googl</a><a href="../tag/python.html">python</a><a href="../tag/qrcode.html">qrcode</a></p>
</footer><!-- /.post-info --><p>Lately I've been interested in improving the interaction of my
<a class="reference external" href="http://agilitycourses.com">agilitycourses</a> website for mobile users. One such improvement is to add
<a class="reference external" href="http://en.wikipedia.org/wiki/QR_Code">QR Codes</a> (aka 2D barcodes) representing the page URLs to the printed
representations of pages served as PDFs.</p>
<p>I found that developers have reverse engineered the &quot;api&quot; of the
<a class="reference external" href="http://goo.gl">goo.gl</a> URL shortening web site. In my brief testing it is very fast.
What makes that service extra useful is by adding &quot;.qr&quot; to a shortened
URL it returns a PNG image of the QR Code for the shortened URL. That
made it perfect for providing both short text and QR Code URL
representations for my printed documents.</p>
<p>I threw together a few functions and put them in a module to make it
easy to shorten a long URL, obtain the QR Code PNG and store it using
<a class="reference external" href="http://docs.djangoproject.com/en/dev/topics/files/">Django's Storage functionality</a>:</p>
<pre class="code python literal-block">
<span class="kn">import</span> <span class="nn">osimport</span> <span class="nn">urllib</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">simplejson</span>

<span class="k">def</span> <span class="nf">googl_shorten_url</span><span class="p">(</span><span class="n">long_url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;
    Returns goo.gl shortened url for the provided long_url.
    Code taken from: http://djangosnippets.org/snippets/2220/
    Parameters:
    - `long_url`: the url to supply to goo.gl to be shortened.
    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">({</span><span class="s">'security_token'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">'url'</span><span class="p">:</span> <span class="n">long_url</span><span class="p">})</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">'http://goo.gl/api/shorten'</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())[</span><span class="s">'short_url'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">googl_qrcode</span><span class="p">(</span><span class="n">googl_url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;
    Return file containing qr code image file for the given goo.gl url.
    Parameters:
    - `googl_url`: url from which to obtain the qr code.
    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">googl_url</span> <span class="o">+</span> <span class="s">'.qr'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_url_qr_code_image</span><span class="p">(</span><span class="n">long_url</span><span class="p">,</span> <span class="n">storage</span><span class="p">,</span> <span class="n">storage_image_file_path</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;
    Return goo.gl shortened url and storage name of qr code corresponding to
    the shortened url for the supplied full url. Contacts goo.gl to shorten
    the supplied long url then downloads and stores the qr code image file
    in the storage instance using the file path and the shortened url name
    as the storage name.
    Parameters:
    - `long_url`: the url to shorten.
    - `storage': a Django storage instance into which to store the qr code
    image.
    - `storage_image_file_path`: file system path to prepend to shortened
    url. This path must exist prior to calling this function.
    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">googl_url</span> <span class="o">=</span> <span class="n">googl_shorten_url</span><span class="p">(</span><span class="n">long_url</span><span class="p">)</span>
        <span class="n">qr_file_name</span> <span class="o">=</span> <span class="n">googl_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">'.qr'</span>
        <span class="n">qr_code_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">storage_image_file_path</span><span class="p">,</span> <span class="n">qr_file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">qr_code_name</span><span class="p">):</span>
            <span class="n">qr_buffer</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">qr_code_name</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span>
            <span class="n">qr_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">googl_qrcode</span><span class="p">(</span><span class="n">googl_url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">qr_buffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">googl_url</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">qr_code_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">googl_url</span><span class="p">,</span> <span class="n">qr_code_name</span>
</pre>
<p>Yes, it has a nasty bare try/except. For my uses this is optional
functionality so I never want a failure to stop the main functionality
of the views that use it. Add exception handling appropriate for your
needs.</p>
<p>The main entry point is <tt class="docutils literal">get_url_qr_code_image()</tt>. Here is an example
of its use (assuming you save the code in googl.py):</p>
<pre class="code python literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">googl</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">django.core.files.storage</span> <span class="kn">import</span> <span class="n">default_storage</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">short_url</span><span class="p">,</span> <span class="n">qr_code_storage_name</span> <span class="o">=</span> <span class="n">googl</span><span class="o">.</span><span class="n">get_url_qr_code_image</span><span class="p">(</span><span class="s">'http://google.com'</span><span class="p">,</span> <span class="n">default_storage</span><span class="p">)</span><span class="o">&gt;&gt;&gt;</span> <span class="n">short_urlu</span><span class="s">'http://goo.gl/mR2d'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">qr_code_storage_nameu</span><span class="s">'mR2d.qr'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">default_storage</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">qr_code_storage_name</span><span class="p">)</span><span class="s">u'/home/dev/agilitycourses/static/mR2d.qr'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">default_storage</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="n">qr_code_storage_name</span><span class="p">)</span><span class="s">u'mR2d.qr'</span>
<span class="o">&gt;&gt;&gt;</span>
</pre>
<p>Hope you find this useful.</p>
                </article>
                                    <p class="paginator">
        Page 1 / 1
    </p>
                            </aside><!-- /#featured -->
                                                </ol><!-- /#posts-list -->
                        </section><!-- /#content -->
                    <section id="extras" class="body">
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://tech.agilitynerd.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>