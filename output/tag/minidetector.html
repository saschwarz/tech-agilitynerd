<!DOCTYPE html>
<html lang="en">
<head>
        <title>tech.agilitynerd.com - minidetector</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../theme/css/main.css" type="text/css" />
                <link href="http://tech.agilitynerd.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="tech.agilitynerd.com Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie.css"/>
                <script src="../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">tech.agilitynerd.com </a></h1>
                <nav><ul>
                                                                                                    <li ><a href="../category/about.html">about</a></li>
                                    <li ><a href="../category/devops.html">devops</a></li>
                                    <li ><a href="../category/misc.html">misc</a></li>
                                    <li ><a href="../category/programming.html">programming</a></li>
                                    <li ><a href="../category/python.html">python</a></li>
                                    <li ><a href="../category/webdev.html">webdev</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
                
            

                            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../conditional-mobile-web-site-redirect-in-djang.html">Mobile Web Site Redirects in Django</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2010-10-05T14:34:00">
                Tue 05 October 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/steve-schwarz.html">Steve Schwarz</a>
        </address>
        <p>In <a href="../category/python.html">python</a>. </p>
<p>tags: <a href="../tag/django.html">django</a><a href="../tag/gunicorn.html">gunicorn</a><a href="../tag/minidetector.html">minidetector</a><a href="../tag/mobile.html">mobile</a></p>
</footer><!-- /.post-info --><p>For the mobile version of agilitycourses.com I wanted to follow the
approach Google appears to be using on some of its sites:</p>
<ul class="simple">
<li>If the user views agilitycourses.com from a desktop browser they
should see the standard/desktop version of the site.</li>
<li>If the user views agilitycourses.com from a mobile browser they
should be redirected to a mobile domain (m.agilitycourses.com).</li>
<li>The mobile version of the website includes a link to the standard
version.</li>
<li>If the mobile user chooses the standard website they should &quot;stick&quot;
on that site and not be redirected to the mobile site.</li>
</ul>
<p>I wanted to run two different websites but share templates and have the
templates and css change for the mobile site. That meant that I'd need
to set a variable(s) in the request to use to generate the appropriate
HTML. So I found the simplest mobile device detector <a class="reference external" href="http://code.google.com/p/minidetector/">minidetector</a> and
initially used that. I later found <a class="reference external" href="http://github.com/shelfworthy/minidetector">Chris Drackett's fork</a> has a number
of useful enhancements and switched to it.</p>
<p>But minidetector didn't provide the ability to redirect to another site.
I found <a class="reference external" href="http://www.packtpub.com/article/multiple-templates-in-django">Scott Newman's article</a> on using multiple templates which had
a section on performing the redirect and storing the user's selection in
the session. So I forked Chris' minidetector and modified it to include
the redirect and session storage. At the same time I decided to store
all the minidetector variables into the session and add them, via
middleware, to the request so the raw request wouldn't have to be parsed
each time. My fork is <a class="reference external" href="http://github.com/saschwarz/minidetector">available here</a> with details on the new
configuration options.</p>
<p>I'm using two domains so I can track analytics for the mobile and
non-mobile sites separately and allow users to bookmark the desired
site's pages. I use Google Analytics (via django-google-analytics) and
Awstats for analytics.</p>
<p>Since I'm using two separate domain and sharing everything else I'm
using a setup similar to the one described by <a class="reference external" href="http://www.nerdydork.com/mobile-app-on-subdomain-with-django.html">Dustin Davis</a>. I have a
settings.py file and a mobile_settings.py that only overrides the
features I need:</p>
<pre class="literal-block">
from settings import *
SITE_ID = 2
CACHE_MIDDLEWARE_KEY_PREFIX = &quot;m.ac-&quot;
</pre>
<p>I use a different memcached key prefix so the cached pages for the
mobile site don't clash with those for the desktop site.</p>
<p>I setup m.agilitycourses on my server using the same <a class="reference external" href="http://tech.agilitynerd.com/configuring-runit-for-gunicorn-and-django-ins">Gunicorn setup I
used for agilitycourses.com</a> with the only changes being specifying the
<tt class="docutils literal"><span class="pre">--bind</span> address/port</tt> and the name of the mobile settings file:</p>
<pre class="literal-block">
#!/bin/sh
GUNICORN=/home/user/virtualenvs/myapp/bin/gunicorn_django
ROOT=/home/user/source/myapp
PID=/var/run/myapp.pid
if [ -f $PID ]
&nbsp;&nbsp;&nbsp; then rm $PID fi
cd $ROOT
exec $GUNICORN --bind 127.0.0.1:8001 -c $ROOT/gunicorn.conf.py --pid=$PID $ROOT/mobile_settings.py
</pre>
<p>If my templates/content start to diverge more significantly between the
mobile and desktop sites I may set the TEMPLATE_DIRS differently in the
mobile_settings file. Or I can move to Dustin's approach and create a
new application containing the urls.py and views.py specific to my
mobile deployment. I would think diverging further would call for a
refactoring of the common functionality to its own application which
could be imported into separate code branches for each domain.</p>
                </article>
                                    <p class="paginator">
        Page 1 / 1
    </p>
                            </aside><!-- /#featured -->
                                                </ol><!-- /#posts-list -->
                        </section><!-- /#content -->
                    <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://docs.notmyidea.org/alexis/pelican/">Pelican</a></li>
                                                    <li><a href="http://python.org">Python.org</a></li>
                                                    <li><a href="http://jinja.pocoo.org">Jinja2</a></li>
                                                    <li><a href="#">You can modify those links in your config file</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://tech.agilitynerd.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="#">You can add links in your config file</a></li>
                                                    <li><a href="#">Another social link</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>