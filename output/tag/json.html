<!DOCTYPE html>
<html lang="en">
<head>
        <title>tech.agilitynerd.com - json</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../theme/css/main.css" type="text/css" />
                <link href="http://tech.agilitynerd.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="tech.agilitynerd.com Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie.css"/>
                <script src="../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">tech.agilitynerd.com </a></h1>
                <nav><ul>
                                                                                                    <li ><a href="../category/about.html">about</a></li>
                                    <li ><a href="../category/devops.html">devops</a></li>
                                    <li ><a href="../category/misc.html">misc</a></li>
                                    <li ><a href="../category/programming.html">programming</a></li>
                                    <li ><a href="../category/python.html">python</a></li>
                                    <li ><a href="../category/webdev.html">webdev</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
                
            

                            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../embedding-json-within-generated-html.html">Embedding JSON Within Generated HTML</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2010-07-08T21:03:00">
                Thu 08 July 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/steve-schwarz.html">Steve Schwarz</a>
        </address>
        <p>In <a href="../category/webdev.html">webdev</a>. </p>
<p>tags: <a href="../tag/html.html">html</a><a href="../tag/javascript.html">javascript</a><a href="../tag/json.html">json</a><a href="../tag/python.html">python</a><a href="../tag/webdevelopment.html">webdevelopment</a></p>
</footer><!-- /.post-info --><p>Ran into an interesting problem at work this past week that had a simple
and pleasing resolution. We have an in house developed JavaScript grid
on some of our pages and when users entered some text strings we'd
generate invalid <a class="reference external" href="http://www.json.org/js.html">JSON</a> payloads that would give the user an error
page. If they entered strings that looked like an HTML Entity i.e. &amp;#13
which (with the addition of a trailing ; ) is a non-visible HTML
character (carriage return) the text wasn't displayed in the widget. To
further complicate things some of the content displayed in the grid is
HTML which is inserted into the grid as is and can contain escaped HTML
characters.</p>
<p>The grid gets its content as a JSON payload from within a hidden div in
the HTML which is generated via a template mechanism. Heres a portion of
the template where &lt;%= and %&gt; stringifying of the value of the Python
variable(s)/code they surround:</p>
<pre class="literal-block">
&lt;div style=&quot;display:none;&quot; id=&quot;grid-init-args-&lt;%= count %&gt;&quot;&gt;
  &lt;textarea&gt;
  &lt;!-- this is the JSON payload loaded via the grid JavaScript --&gt;
  &lt;%= [ columnsIndex, indexColumns, columns, rowBuffer, footerRows, formulas] %&gt;
  &lt;/textarea&gt;
&lt;/div&gt;
</pre>
<p>This approach has a number of problems:</p>
<ol class="arabic simple">
<li>By using the template mechanism to create the JSON payload this
template was relying on the similarity of the string representation
of Python objects to JSON. After some testing I found the following
scenarios: If a string contained a single quote character the string
representation was a double quoted string around the text and the
single quote; a valid JSON string. If the string contained a double
quote character the string representation was a single quoted string
around the text and the double quote; <a class="reference external" href="http://www.bennadel.com/blog/388-People-Please-Stop-Using-Single-Quotes-.htm">an invalid JSON string</a>. If
the string contained both a single and a double quote the string
representation would be a single quoted string containing a slash
escaped single quote and the double quote; an invalid JSON string.
Depending on the browser (of course) the JSON string would fail to
parse correctly when the double quote was encountered within the
single quoted string.</li>
<li>The JSON payload had to be HTML encoded (converting &lt;, &gt;, &quot;, and &amp;)
since it was parsed by the browser as HTML.</li>
<li>The HTML encoding would encode or double encode HTML to be inserted
directly into the grid's DOM.</li>
</ol>
<p>The variation in single/double quoting was an easy fix, I changed to
<a class="reference external" href="http://pypi.python.org/pypi/simplejson/">simplejson</a>.dumps() which correctly double quotes key/values in dicts
and escapes embedded double quotes (single quotes don't need to be
escaped). I didn't time it but with the C extension it may be faster
than the template engine for our larger datasets.</p>
<p>I played around with (not) encoding various portions of the payload and
then it hit me that I should change the grid to get its payload from a
non HTML element so that only HTML destined for insertion into the DOM
would be HTML encoded (which is as you'd expect for normal HTML
handling). I started changing the payload to be stored in JavaScript
generated in the template but didn't like the impact the change would
have on all the existing templates. So I started Googling and found <a class="reference external" href="http://www.bennadel.com/blog/1603-jQuery-And-Script-Tags-As-Data-Containers.htm">Ben
Nadel's blog post on using script tags as data containers</a>.</p>
<p>So here's my solution:</p>
<pre class="literal-block">
&lt;div style=&quot;display:none;&quot; id=&quot;grid-init-args-&lt;%= count %&gt;&quot;&gt;
&lt;script type=&quot;application/json&quot;&gt;
&lt;%= simplejson.dumps([ columnsIndex, indexColumns, columns, rowBuffer, footerRows, formulas]) %&gt;
&lt;/script&gt;
&lt;/div&gt;
</pre>
<p>There were two changes:</p>
<ol class="arabic simple">
<li>Used <tt class="docutils literal">simplejson.dumps</tt> to correctly double quote and escape double
quotes within the variables in the payload.</li>
<li>Change the textarea to a script element.</li>
</ol>
<p>By converting to a script tag within the hidden div the HTML parser no
longer parsed the content of the JSON payload. so the JSON payload only
needed to HTML encode HTML elements that were being inserted into the
DOM created by the grid.</p>
<p>This change also meant I was able to delete the unnecessary HTML
encoding of non-HTML JSON payload data. Got to love solutions that
involve deleting code.</p>
<p>Ultimately, we'll convert to loading the JSON payload as a separate AJAX
request from the page to the server, but for now this simplifies the
markup and handles all types of user input and HTML encoded characters
correctly.</p>
                </article>
                                    <p class="paginator">
        Page 1 / 1
    </p>
                            </aside><!-- /#featured -->
                                                </ol><!-- /#posts-list -->
                        </section><!-- /#content -->
                    <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://docs.notmyidea.org/alexis/pelican/">Pelican</a></li>
                                                    <li><a href="http://python.org">Python.org</a></li>
                                                    <li><a href="http://jinja.pocoo.org">Jinja2</a></li>
                                                    <li><a href="#">You can modify those links in your config file</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://tech.agilitynerd.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="#">You can add links in your config file</a></li>
                                                    <li><a href="#">Another social link</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>