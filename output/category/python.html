<!DOCTYPE html>
<html lang="en">
<head>
        <title>tech.agilitynerd.com - python</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../theme/css/main.css" type="text/css" />
                <link href="http://tech.agilitynerd.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="tech.agilitynerd.com Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie.css"/>
                <script src="../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">tech.agilitynerd.com </a></h1>
                <nav><ul>
                                                                                                    <li ><a href="../category/about.html">about</a></li>
                                    <li ><a href="../category/devops.html">devops</a></li>
                                    <li ><a href="../category/misc.html">misc</a></li>
                                    <li ><a href="../category/programming.html">programming</a></li>
                                    <li class="active"><a href="../category/python.html">python</a></li>
                                    <li ><a href="../category/webdev.html">webdev</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
                
            

                            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../my-favorite-orm-anti-pattern.html">My Favorite ORM and Python Anti-Patterns</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2012-05-12T23:57:00">
                Sat 12 May 2012
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/steve-schwarz.html">Steve Schwarz</a>
        </address>
        <p>In <a href="../category/python.html">python</a>. </p>
<p>tags: <a href="../tag/antipattern.html">antipattern</a><a href="../tag/development.html">development</a><a href="../tag/orm.html">orm</a><a href="../tag/python.html">python</a></p>
</footer><!-- /.post-info --><p>At work I was looking at improving the performance of one of our slower
web pages. It can be rewarding to find a little piece of code that can
be easily optimized. This time there were several functions that were
adding 10+ sec to the page in worst case. It wasn't a problem for most
clients, but when clients with who are related to many other clients hit
the page they'd experience terrible performance. Here's pseudo code for
the combination of anti-patterns that caused the problem:</p>
<pre class="literal-block">
# Projects have users and users are in different organizations
# (project can contain multiple organization's users)
activeOrganizationProjectUsers = [x for x in project.users
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if x.active and x.organization == organization]
if activeOrganizationProjectUsers:
&nbsp;&nbsp;&nbsp; # do something *NOT* using activeOrganizationProjectUsers
</pre>
<p>There are two main problems with this code:</p>
<ol class="arabic simple">
<li>It ignores the fact the project, users, and organization are backed
by an ORM</li>
<li>The list comprehension is being used to find all matching elements
when only a single element is needed.</li>
</ol>
<div class="section" id="ignoring-the-orm">
<h2>Ignoring the ORM</h2>
<p>The code above wouldn't be too bad if these were just lists of objects
in memory. But being objects that are instantiated by an ORM a number of
database queries will be issued. In this particular case (w/o eager
loading across user to the organization table) the following queries
where executed:</p>
<ol class="arabic simple">
<li>Join project to user and get all users for the project's id</li>
<li>For each user load their organization (one by one) if the user is
active</li>
</ol>
<p>So in the case where there were hundreds of users on a project there
were hundreds of queries executed and hundreds of User and Organization
instances were instantiated. Depending on the size of the objects (and
the ORM's behavior) it can take &quot;real time&quot; to fetch and instantiate all
these large objects.</p>
<p>This code base has this kind of code sprinkled through out it. At one
time during it's development the developers were encouraged to treat ORM
backed objects as though they were Plain Old Python Objects (POPOs). The
developer wouldn't necessarily see the performance degradation using
small data sets either. This is one of the reasons why I like to tail
the database log (or use <a class="reference external" href="http://github.com/robhudson/django-debug-toolbar">django-debug-toolbar</a> if I''m using Django)
to see the queries go by.</p>
</div>
<div class="section" id="using-list-comprehensions-when-a-single-value-is-needed">
<h2>Using List Comprehensions When a Single Value is Needed</h2>
<p>To make this situation worse, the activeOrganizationProjectUsers list
wasn't actually used. This is a combination of a Python anti-pattern and
the ORM anti-pattern. What was required was to determine if a single
active organization user existed.</p>
<p>I believe the original developer(s) used the list comprehension solution
in a combination of ignorance and syntactic sugar. They didn't want to
write a new function to do the query and put it in the User class so
they used the existing class's API. The syntactic sugar was using the
list comprehension to get more values than the one that was needed. If
this wasn't a (potentially) expensive ORM backed operation the original
code could have been:</p>
<pre class="literal-block">
activeOrganizationProjectUsers = False
for x in project.users:
&nbsp;&nbsp;&nbsp; if x.active and x.organization == organization:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; activeOrganizationProjectUsers = True
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break
if activeOrganizationProjectUsers:
&nbsp;&nbsp;&nbsp; # do something
</pre>
<p>But this solution could still query all possible user/organization
combinations. The other question would be: which set is larger the
organization users or the project users? It is likely looping over the
organization's users looking for active ones would be more efficient
anyway.</p>
</div>
<div class="section" id="remember-the-underlying-representation">
<h2>Remember the Underlying Representation</h2>
<p>When performance matters remembering the objects are ORM backed is
important. So in this case a single query was all that was required
(SqlObject pseudo syntax):</p>
<pre class="literal-block">
activeOrganizationProjectUsers = Users.selectBy(project=project,
                     &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; active=True,
                     &nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; organization=organization).count() &gt; 0
</pre>
<p>If abstracting out the ORM's methods is important this new function
could be added to the appropriate class as a method. In my case making a
change to use a query resulted in cutting the page load time by two
orders of magnitude.</p>
</div>
                </article>
                            </aside><!-- /#featured -->
                            <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">
                                                

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../adding-rsvg-to-a-virtualenv-created-with-no-s.html" rel="bookmark"
                           title="Permalink to Adding pyrsvg to a virtualenv created with --no-site-packages">Adding pyrsvg to a virtualenv created with --no-site-packages</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-10-12T03:02:00">
                Tue 12 October 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/steve-schwarz.html">Steve Schwarz</a>
        </address>
        <p>In <a href="../category/python.html">python</a>. </p>
<p>tags: <a href="../tag/python.html">python</a><a href="../tag/rsvg.html">rsvg</a><a href="../tag/virtualenv.html">virtualenv</a></p>
</footer><!-- /.post-info -->                <p>I set up my development and deployment environments on Ubuntu with
<a class="reference external" href="http://pypi.python.org/pypi/virtualenv">virtualenv</a>with the <tt class="docutils literal"><span class="pre">--no-site-packages</span></tt> option to isolate them from
packages in the system installation. My application uses <a class="reference external" href="http://cairographics.org/pyrsvg/">pyrsvg</a>and
it is installed by default as a system package. Consequently I had to
link the shared libraries it installs (w ...</p>
                <a class="readmore" href="../adding-rsvg-to-a-virtualenv-created-with-no-s.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../conditional-mobile-web-site-redirect-in-djang.html" rel="bookmark"
                           title="Permalink to Mobile Web Site Redirects in Django">Mobile Web Site Redirects in Django</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-10-05T14:34:00">
                Tue 05 October 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/steve-schwarz.html">Steve Schwarz</a>
        </address>
        <p>In <a href="../category/python.html">python</a>. </p>
<p>tags: <a href="../tag/django.html">django</a><a href="../tag/gunicorn.html">gunicorn</a><a href="../tag/minidetector.html">minidetector</a><a href="../tag/mobile.html">mobile</a></p>
</footer><!-- /.post-info -->                <p>For the mobile version of agilitycourses.com I wanted to follow the
approach Google appears to be using on some of its sites:</p>
<ul class="simple">
<li>If the user views agilitycourses.com from a desktop browser they
should see the standard/desktop version of the site.</li>
<li>If the user views agilitycourses.com from ...</li></ul>
                <a class="readmore" href="../conditional-mobile-web-site-redirect-in-djang.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../configuring-runit-for-gunicorn-and-django-ins.html" rel="bookmark"
                           title="Permalink to Configuring Runit for Gunicorn and Django Installed in a Virtualenv on Ubuntu">Configuring Runit for Gunicorn and Django Installed in a Virtualenv on Ubuntu</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-09-08T03:08:00">
                Wed 08 September 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/steve-schwarz.html">Steve Schwarz</a>
        </address>
        <p>In <a href="../category/python.html">python</a>. </p>
<p>tags: <a href="../tag/apache.html">apache</a><a href="../tag/django.html">django</a><a href="../tag/gunicorn.html">gunicorn</a><a href="../tag/runit.html">runit</a><a href="../tag/ubuntu.html">ubuntu</a><a href="../tag/virtualenv.html">virtualenv</a></p>
</footer><!-- /.post-info -->                <p>I couldn't find any documentation that covered all the pieces for
configuring my latest Django site so I hope this helps someone else out.</p>
<p>I had used mod_wsgi under Apache for my other Django sites. But now I'm
using different python versions for the sites (until if/when ...</p>
                <a class="readmore" href="../configuring-runit-for-gunicorn-and-django-ins.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../initial-release-of-django-stw.html" rel="bookmark"
                           title="Permalink to Initial Release of django-stw">Initial Release of django-stw</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-07-11T15:47:00">
                Sun 11 July 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/steve-schwarz.html">Steve Schwarz</a>
        </address>
        <p>In <a href="../category/python.html">python</a>. </p>
<p>tags: <a href="../tag/django.html">django</a><a href="../tag/github.html">github</a><a href="../tag/googility.html">googility</a><a href="../tag/pypi.html">pypi</a><a href="../tag/python.html">python</a><a href="../tag/shrinktheweb.html">shrinktheweb</a><a href="../tag/webdevelopment.html">webdevelopment</a></p>
</footer><!-- /.post-info -->                <p>I have been using the free website thumbnail service from <a class="reference external" href="http://www.shrinktheweb.com?a=988">Shrink The
Web</a> on my dog agility search website <a class="reference external" href="http://googility.com">Googility</a> since I launched it.
It is quick and easy to use and it adds a lot to the look of the pages.</p>
<p>I had created a simple <a class="reference external" href="http://djangoproject.com/">Django</a> template tag ...</p>
                <a class="readmore" href="../initial-release-of-django-stw.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            </ol><!-- /#posts-list -->
                            <p class="paginator">
        Page 1 / 1
    </p>
                        </section><!-- /#content -->
                    <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://docs.notmyidea.org/alexis/pelican/">Pelican</a></li>
                                                    <li><a href="http://python.org">Python.org</a></li>
                                                    <li><a href="http://jinja.pocoo.org">Jinja2</a></li>
                                                    <li><a href="#">You can modify those links in your config file</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://tech.agilitynerd.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="#">You can add links in your config file</a></li>
                                                    <li><a href="#">Another social link</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>