<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <title>tech.agilitynerd</title>
    <meta name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Steve Schwarz">
    <!-- <link href="http://127.0.0.1:8000/TechAgilityNerd" type="application/atom+xml" rel="alternate" title="tech.agilitynerd Atom Feed" /> -->
    <link href="http://feeds.feedburner.com/TechAgilityNerd" type="application/atom+xml" rel="alternate" title="tech.agilitynerd Atom Feed" />
    <!-- Le styles -->
    <link href="http://tech.agilitynerd.com/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
      body {
      padding-top: 60px;
      padding-bottom: 40px;
      }
      .sidebar-nav {
      padding: 9px 0;
      }
    </style>
    <link href="http://tech.agilitynerd.com/theme/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="http://tech.agilitynerd.com/theme/local.css" rel="stylesheet">
    <link href="http://tech.agilitynerd.com/theme/pygments.css" rel="stylesheet">
<script>var _gaq=[['_setAccount','UA-1127677-3'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))</script>
<script type="text/javascript">
  var disqus_shortname = "techagilitynerd"; // required: replace example with your forum shortname
  var disqus_developer = 1;
  
  var disqus_identifier = "obtain-short-urls-and-their-qr-codes-for-djan.html";
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();

  (function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>
  </head>
  <body>
<!--[if lt IE 7]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->
    
<div class="navbar navbar-inverse navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container-fluid">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
      </a>
      <a class="brand" href="http://tech.agilitynerd.com/index.html">tech.agilitynerd</a>
      <div class="nav-collapse collapse">
	<ul class="nav">
	  <li ><a href="http://tech.agilitynerd.com/category/devops.html">devops</a></li>
	  <li ><a href="http://tech.agilitynerd.com/category/javascript.html">javascript</a></li>
	  <li ><a href="http://tech.agilitynerd.com/category/misc.html">misc</a></li>
	  <li ><a href="http://tech.agilitynerd.com/category/programming.html">programming</a></li>
	  <li ><a href="http://tech.agilitynerd.com/category/python.html">python</a></li>
	  <li class="active"><a href="http://tech.agilitynerd.com/category/webdev.html">webdev</a></li>
	</ul>
	<p class="navbar-text pull-right">
	  <a class="navbar-link" href="http://tech.agilitynerd.com/archives.html">[archives]</a>
	  <a class="navbar-link" href="http://tech.agilitynerd.com/tags.html">[tags]</a>
	</p>
      </div><!--/.nav-collapse -->
    </div>
  </div>
</div>
    <div class="container-fluid">
      <div class="row-fluid">
	<div class="span1">&nbsp;</div>
	<div class="span10">
	  <div class="row-fluid">
            <div class="span9">
<div class='article'>
  <div class="page-header"><h1>Obtain Short URLs and QR-Codes for Django Apps</h1></div>
  <div class="well small"><a class="more" href="http://tech.agilitynerd.com/obtain-short-urls-and-their-qr-codes-for-djan.html">On 22 Oct 2010 at 0400</a>
by <a class="url fn" href="http://tech.agilitynerd.com/author/steve-schwarz.html">Steve Schwarz</a> in <a href="http://tech.agilitynerd.com/category/webdev.html">webdev</a>
 | <a href="http://tech.agilitynerd.com/obtain-short-urls-and-their-qr-codes-for-djan.html#disqus_thread">Comments</a></div>
  <div><p>Lately I've been interested in improving the interaction of my
<a class="reference external" href="http://agilitycourses.com">agilitycourses</a> website for mobile users. One such improvement is to add
<a class="reference external" href="http://en.wikipedia.org/wiki/QR_Code">QR Codes</a> (aka 2D barcodes) representing the page URLs to the printed
representations of pages served as PDFs.</p>
<p>I found that developers have reverse engineered the &quot;api&quot; of the
<a class="reference external" href="http://goo.gl">goo.gl</a> URL shortening web site. In my brief testing it is very fast.
What makes that service extra useful is by adding &quot;.qr&quot; to a shortened
URL it returns a PNG image of the QR Code for the shortened URL. That
made it perfect for providing both short text and QR Code URL
representations for my printed documents.</p>
<p>I threw together a few functions and put them in a module to make it
easy to shorten a long URL, obtain the QR Code PNG and store it using
<a class="reference external" href="http://docs.djangoproject.com/en/dev/topics/files/">Django's Storage functionality</a>:</p>
<pre class="code python literal-block">
<span class="kn">import</span> <span class="nn">osimport</span> <span class="nn">urllib</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">simplejson</span>

<span class="k">def</span> <span class="nf">googl_shorten_url</span><span class="p">(</span><span class="n">long_url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;
    Returns goo.gl shortened url for the provided long_url.
    Code taken from: http://djangosnippets.org/snippets/2220/
    Parameters:
    - `long_url`: the url to supply to goo.gl to be shortened.
    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">({</span><span class="s1">'security_token'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">'url'</span><span class="p">:</span> <span class="n">long_url</span><span class="p">})</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s1">'http://goo.gl/api/shorten'</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())[</span><span class="s1">'short_url'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">googl_qrcode</span><span class="p">(</span><span class="n">googl_url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;
    Return file containing qr code image file for the given goo.gl url.
    Parameters:
    - `googl_url`: url from which to obtain the qr code.
    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">googl_url</span> <span class="o">+</span> <span class="s1">'.qr'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_url_qr_code_image</span><span class="p">(</span><span class="n">long_url</span><span class="p">,</span> <span class="n">storage</span><span class="p">,</span> <span class="n">storage_image_file_path</span><span class="o">=</span><span class="s1">''</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;
    Return goo.gl shortened url and storage name of qr code corresponding to
    the shortened url for the supplied full url. Contacts goo.gl to shorten
    the supplied long url then downloads and stores the qr code image file
    in the storage instance using the file path and the shortened url name
    as the storage name.
    Parameters:
    - `long_url`: the url to shorten.
    - `storage': a Django storage instance into which to store the qr code
    image.
    - `storage_image_file_path`: file system path to prepend to shortened
    url. This path must exist prior to calling this function.
    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">googl_url</span> <span class="o">=</span> <span class="n">googl_shorten_url</span><span class="p">(</span><span class="n">long_url</span><span class="p">)</span>
        <span class="n">qr_file_name</span> <span class="o">=</span> <span class="n">googl_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'.qr'</span>
        <span class="n">qr_code_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">storage_image_file_path</span><span class="p">,</span> <span class="n">qr_file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">qr_code_name</span><span class="p">):</span>
            <span class="n">qr_buffer</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">qr_code_name</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span>
            <span class="n">qr_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">googl_qrcode</span><span class="p">(</span><span class="n">googl_url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">qr_buffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">googl_url</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">qr_code_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">googl_url</span><span class="p">,</span> <span class="n">qr_code_name</span>
</pre>
<p>Yes, it has a nasty bare try/except. For my uses this is optional
functionality so I never want a failure to stop the main functionality
of the views that use it. Add exception handling appropriate for your
needs.</p>
<p>The main entry point is <tt class="docutils literal">get_url_qr_code_image()</tt>. Here is an example
of its use (assuming you save the code in googl.py):</p>
<pre class="code python literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">googl</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">django.core.files.storage</span> <span class="kn">import</span> <span class="n">default_storage</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">short_url</span><span class="p">,</span> <span class="n">qr_code_storage_name</span> <span class="o">=</span> <span class="n">googl</span><span class="o">.</span><span class="n">get_url_qr_code_image</span><span class="p">(</span><span class="s1">'http://google.com'</span><span class="p">,</span> <span class="n">default_storage</span><span class="p">)</span><span class="o">&gt;&gt;&gt;</span> <span class="n">short_urlu</span><span class="s1">'http://goo.gl/mR2d'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">qr_code_storage_nameu</span><span class="s1">'mR2d.qr'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">default_storage</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">qr_code_storage_name</span><span class="p">)</span><span class="s1">u'/home/dev/agilitycourses/static/mR2d.qr'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">default_storage</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="n">qr_code_storage_name</span><span class="p">)</span><span class="s1">u'mR2d.qr'</span>
<span class="o">&gt;&gt;&gt;</span>
</pre>
<p>Hope you find this useful.</p>
</div>
  <div>
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</div>	
            </div><!--/span-->

	    <div class="span3">
<div class="author">
<h4>About</h4>
<div class="author-about">
  <p class="about">I'm Steve Schwarz a Chicago software developer and dog agility enthusiast. <a href="/pages/about.html">more</a></p>
</div>
</div>
<div class="well sidebar-nav">
  <ul class="nav nav-list">
    <li class="nav-header">Blogroll</li>
    <li><a href="http://agilitynerd.com/blog/">agilitynerd.com</a></li>
    <li><a href="http://agilitycourses.com/">agilitycourses.com</a></li>
    <li><a href="http://googility.com/">googility.com</a></li>
  </ul>
  <ul class="nav nav-list social">
    <li class="nav-header">Elsewhere</li>
    <li><a href="http://www.linkedin.com/profile/view?id=10135443">Linked in</a></li>
    <li><a href="https://github.com/saschwarz">GitHub</a></li>
    <li><a href="https://twitter.com/steveaschwarz">Twitter</a></li>
  </ul>
</div><!--/.well -->
 <script>
  (function() {
    var cx = '001042720131993941673:szhtogqckem';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<div class="search">
    <gcse:search></gcse:search>
</div>
            </div><!--/span-->

	  </div>
	</div>
      </div><!--/row-->

      <hr>

      <footer>
        <p>Powered by <a href="http://blog.getpelican.com/">Pelican</a></p>
	<p>&copy; Steve Schwarz 2016</p>
      </footer>

    </div><!--/.fluid-container-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="http://tech.agilitynerd.com/theme/js/jquery-1.7.2.min.js"><\/script>')</script>
      <script src="http://tech.agilitynerd.com/theme/bootstrap/js/bootstrap.min.js"></script>
      <script src="http://tech.agilitynerd.com/theme/js/modernizr-2.5.3-respond-1.1.0.min.js"></script>

  </body>
</html>