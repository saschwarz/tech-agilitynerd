<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <title>tech.agilitynerd</title>
    <meta name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Steve Schwarz">      <!-- <link href="http://127.0.0.1:8000/TechAgilityNerd" type="application/atom+xml" rel="alternate" title="tech.agilitynerd Atom Feed" /> -->
    <link href="http://feeds.feedburner.com/TechAgilityNerd" type="application/atom+xml" rel="alternate" title="tech.agilitynerd Atom Feed" />       <!-- Le styles -->
    <link href="https://tech.agilitynerd.com/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }

        .sidebar-nav {
            padding: 9px 0;
        }

        @media (max-width: 767px) {
            .sidebar {
                margin-top: 2em;
                border-top: 1px solid #e3e3e3;
                padding-top: 1em;
            }
            .sidebar .search {
                margin-bottom: 0;
            }
        }
    </style>
    <link href="https://tech.agilitynerd.com/theme/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="https://tech.agilitynerd.com/theme/local.css" rel="stylesheet">
    <link href="https://tech.agilitynerd.com/theme/pygments.css" rel="stylesheet"> <script>var _gaq=[['_setAccount','UA-1127677-3'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))</script>
 <script type="text/javascript">
  var disqus_shortname = "techagilitynerd"; // required: replace example with your forum shortname
  var disqus_developer = 1;
  
  var disqus_identifier = "nginx-https-lets-encrypt-and-django.html";
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();

  (function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>
</head>

<body>
    <!--[if lt IE 7]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->
  <div class="navbar navbar-inverse navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container-fluid">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
      </a>
      <a class="brand" href="https://tech.agilitynerd.com/index.html">tech.agilitynerd</a>
      <div class="nav-collapse collapse">
	<ul class="nav">
	  <li class="active"><a href="https://tech.agilitynerd.com/category/devops.html">devops</a></li>
	  <li ><a href="https://tech.agilitynerd.com/category/javascript.html">javascript</a></li>
	  <li ><a href="https://tech.agilitynerd.com/category/misc.html">misc</a></li>
	  <li ><a href="https://tech.agilitynerd.com/category/programming.html">programming</a></li>
	  <li ><a href="https://tech.agilitynerd.com/category/python.html">python</a></li>
	  <li ><a href="https://tech.agilitynerd.com/category/webdev.html">webdev</a></li>
	</ul>
	<p class="navbar-text pull-right">
	  <a class="navbar-link" href="https://tech.agilitynerd.com/archives.html">[archives]</a>
	  <a class="navbar-link" href="https://tech.agilitynerd.com/tags.html">[tags]</a>
	</p>
      </div><!--/.nav-collapse -->
    </div>
  </div>
</div>
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span1">&nbsp;</div>
            <div class="span10">
                <div class="row-fluid">
                    <div class="span9">
 <div class='article'>
  <div class="page-header"><h1>NGINX, HTTPS, Let's Encrypt, and Django</h1></div>
  <div class="well small"><a class="more" href="https://tech.agilitynerd.com/nginx-https-lets-encrypt-and-django.html">On 04 Sep 2016 at 1202</a>
by <a class="url fn" href="https://tech.agilitynerd.com/author/steve-schwarz.html">Steve Schwarz</a> in <a href="https://tech.agilitynerd.com/category/devops.html">devops</a>
 | <a href="https://tech.agilitynerd.com/nginx-https-lets-encrypt-and-django.html#disqus_thread">Comments</a></div>
  <div><p>My <a class="reference external" href="https://agilitycourses.com">agilitycourses.com</a> website is served by <a class="reference external" href="https://nginx.org/en/">nginx</a> proxying to <a class="reference external" href="http://gunicorn.org/">gunicorn</a> running my <a class="reference external" href="https://www.djangoproject.com/">Django</a> application. I'll be adding user accounts soon so I wanted to convert the site to be more secure by using HTTPS encryption. Also <a class="reference external" href="https://webmasters.googleblog.com/2014/08/https-as-ranking-signal.html">Google has announced it will likely prefer sites using HTTPS</a>.</p>
<p>The site is running on Ubuntu 14.04 LTS. I won't recount the whole process, I followed some great resources and I'll discuss a couple adjustments that might be helpful to others.</p>
<ol class="arabic simple">
<li>I basically followed the instructions in this excellent Digital Ocean tutorial: <a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04">How To Secure Nginx with Let's Encrypt on Ubuntu 14.04</a>.</li>
<li>I confirmed via the <a class="reference external" href="https://www.ssllabs.com/ssltest/analyze.html">SSL Labs SSL Server Test</a> that my IPv4 and IPv6 server configurations had &quot;A+&quot; ratings.</li>
<li>While looking for other SSL testing sites I came across <a class="reference external" href="https://securityheaders.io/">securityheaders.io</a> developed by <a class="reference external" href="https://scotthelme.co.uk/">Scott Helme</a>. My initial score was a sad &quot;D&quot;. The site has snippets for NGINX and Apache configuration changes and in depth articles describing the how and the why.</li>
<li>While investigating the changes to the HTTP Headers to improve my test score I came across this <a class="reference external" href="https://github.com/jonnybarnes/nginx-conf">nginx-conf GitHub repository</a>. Specifically the idea of putting the header settings into an <a class="reference external" href="https://github.com/jonnybarnes/nginx-conf/blob/master/conf/includes/security-headers.conf">NGINX include file</a>. I have several other domains on the same server and will also be converting them. I used that idea to include ssl and header configurations into any virtual host.</li>
</ol>
<p>Here's my <cite>/etc/nginx/ssl.conf</cite> file:</p>
<pre class="literal-block">
# From https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
ssl_prefer_server_ciphers on;
ssl_dhparam /etc/ssl/certs/dhparam.pem;
ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';
ssl_session_timeout 1d;
ssl_session_cache shared:SSL:50m;
ssl_stapling on;
ssl_stapling_verify on;
</pre>
<p>And my <cite>/etc/nginx/security_headers.conf</cite> file:</p>
<pre class="literal-block">
# See https://github.com/jonnybarnes/nginx-conf/blob/master/conf/includes/security-headers.conf
add_header X-Xss-Protection &quot;1; mode=block&quot;;
add_header X-Content-Type-Options &quot;nosniff&quot;;
add_header Content-Security-Policy &quot;default-src https: data: 'unsafe-inline' 'unsafe-eval'&quot;;
add_header Strict-Transport-Security max-age=15768000;
</pre>
<p>So my server blocks with all these edits are now:</p>
<pre class="literal-block">
# redirect http://www.tld and http://tld to https://www.tld
server {
    listen 80;
    listen [::]:80;
    server_name www.agilitycourses.com agilitycourses.com;

    # letsencrypt location
    location ^~ /.well-known/ {
        allow all;
        root /usr/share/nginx/html/;
    }
    location / {
        return 301 https://www.agilitycourses.com$request_uri;
    }
}

# redirect https://tld to https://www.tld
server {
    listen 443 ssl;
    listen [::]:443 ipv6only=on ssl;

    server_name agilitycourses.com;
    # certificates are needed here too
    ssl_certificate /etc/letsencrypt/live/agilitycourses.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/agilitycourses.com/privkey.pem;
    return 301 https://www.agilitycourses.com$request_uri;
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name www.agilitycourses.com;
    root /home/agilitycourses/production/current/;

    ssl_certificate /etc/letsencrypt/live/agilitycourses.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/agilitycourses.com/privkey.pem;

    include /etc/nginx/ssl.conf;
    include /etc/nginx/security_headers.conf;
    ...
}
</pre>
<p>So now I have an &quot;A&quot; score from <cite>securityheaders.io</cite></p>
<ol class="arabic" start="5">
<li><p class="first">The Digital Ocean tutorial sets up a root crontab entry to automatically update the SSL Certificate. I decided to also update the letsencrypt client software automatically:</p>
<pre class="literal-block">
# m h  dom mon dow   command
20 2 * * 1 cd /opt/letsencrypt &amp;&amp; git pull
30 2 * * 1 /opt/letsencrypt/letsencrypt-auto renew &gt;&gt; /var/log/le-renew.log
35 2 * * 1 /etc/init.d/nginx reload
</pre>
</li>
<li><p class="first">The last change I made was to pass along the presence/absence of HTTPS from NGINX to Gunicorn/Django via the <cite>X-Forwarded-Proto</cite> header as <a class="reference external" href="https://docs.djangoproject.com/en/1.10/topics/security/#ssl-https">described in the Django SSL/HTTPS docs</a></p>
<pre class="literal-block">
location &#64;proxy-to-app {
    proxy_pass http://agilitycourses-production-gunicorn;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Accept-Encoding &quot;&quot;;
    proxy_read_timeout 120;
    proxy_send_timeout 120;
    ...
}
</pre>
</li>
<li><p class="first">Based on the Django recommendations I also made these changes in my <cite>settings.py</cite>:</p>
<pre class="literal-block">
# SSL settings
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
SECURE_BROWSER_XSS_FILTER = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
</pre>
</li>
</ol>
<p>Even with a lot of web browsing to learn about these settings the whole process only took a couple hours.
Now that I've done it once (and updated my <a class="reference external" href="http://www.fabfile.org/">Fabric fabfile.py</a>) it will be easier to convert my other domains.</p>
</div>
  <div>
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</div>	
                    </div>
                    <!--/span-->

                    <div class="span3 sidebar">
 <script>
  (function() {
    var cx = '001042720131993941673:szhtogqckem';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<div class="search">
    <gcse:search></gcse:search>
</div>
 <hr>
<div class="author">
<h4>About</h4>
<div class="author-about">
  <p class="about">I'm Steve Schwarz a Chicago software developer and dog agility enthusiast.
 <a href="/pages/about.html">more</a></p>
</div>
</div>
<div class="well sidebar-nav">
  <ul class="nav nav-list">
    <li class="nav-header">Blogroll</li>
    <li><a href="https://agilitynerd.com/blog/">agilitynerd.com</a></li>
    <li><a href="https://agilitycourses.com/">agilitycourses.com</a></li>
    <li><a href="https://googility.com/">googility.com</a></li>
  </ul>
  <ul class="nav nav-list social">
    <li class="nav-header">Elsewhere</li>
    <li><a href="https://www.linkedin.com/profile/view?id=10135443">Linked in</a></li>
    <li><a href="https://github.com/saschwarz">GitHub</a></li>
    <li><a href="https://twitter.com/steveaschwarz">Twitter</a></li>
  </ul>
</div><!--/.well -->
                    </div>
                    <!--/span-->

                </div>
            </div>
        </div>
        <!--/row-->

        <hr>

        <footer>
            <p>Powered by <a href="http://blog.getpelican.com/">Pelican</a></p>
            <p>&copy; Steve Schwarz 2017</p>
        </footer>

    </div>
    <!--/.fluid-container-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>
        window.jQuery || document.write('<script src="https://tech.agilitynerd.com/theme/js/jquery-1.7.2.min.js"><\/script>')
    </script>
    <script src="https://tech.agilitynerd.com/theme/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://tech.agilitynerd.com/theme/js/modernizr-2.5.3-respond-1.1.0.min.js"></script>

</body>

</html>